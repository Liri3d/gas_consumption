# modules/config.py
import streamlit as st

def init_session_state():
    """–ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–æ—Å—Ç–æ—è–Ω–∏—è —Å–µ—Å—Å–∏–∏"""
    if 'df' not in st.session_state:
        st.session_state.df = None
    if 'processed' not in st.session_state:
        st.session_state.processed = False
    if 'clusters' not in st.session_state:
        st.session_state.clusters = None
    if 'anomalies' not in st.session_state:
        st.session_state.anomalies = None
    if 'forecast' not in st.session_state:
        st.session_state.forecast = None

def render_settings(df):
    """–†–µ–Ω–¥–µ—Ä–∏–Ω–≥ –≤–∫–ª–∞–¥–∫–∏ –Ω–∞—Å—Ç—Ä–æ–µ–∫"""
    st.header("‚öôÔ∏è –ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Å–∏—Å—Ç–µ–º—ã")
    
    # –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –∑–∞–¥–∞—á
    st.subheader("üìÖ –†–∞—Å–ø–∏—Å–∞–Ω–∏–µ –∑–∞–¥–∞—á")
    render_schedule_settings()
    
    # –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –º–æ–¥–µ–ª–µ–π
    st.subheader("üîß –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –º–æ–¥–µ–ª–µ–π")
    render_model_settings()
    
    # –í–Ω–µ—à–Ω–∏–µ –¥–∞–Ω–Ω—ã–µ
    st.subheader("üìä –í–Ω–µ—à–Ω–∏–µ –¥–∞–Ω–Ω—ã–µ (UC-DAT-02)")
    render_external_data_settings()
    
    # –û—á–∏—Å—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö
    st.subheader("üßπ –û—á–∏—Å—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö")
    render_data_cleanup()

def render_schedule_settings():
    """–ù–∞—Å—Ç—Ä–æ–π–∫–∏ —Ä–∞—Å–ø–∏—Å–∞–Ω–∏—è –∑–∞–¥–∞—á"""
    col1, col2 = st.columns(2)
    
    with col1:
        st.checkbox("–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è –∫–ª–∞—Å—Ç–µ—Ä–∏–∑–∞—Ü–∏—è (—Ä–∞–∑ –≤ –º–µ—Å—è—Ü)", value=True, key="schedule_clustering")
        st.checkbox("–ï–∂–µ–¥–Ω–µ–≤–Ω–æ–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ –∞–Ω–æ–º–∞–ª–∏–π", value=True, key="schedule_anomalies")
        st.checkbox("–ï–∂–µ–Ω–µ–¥–µ–ª—å–Ω–æ–µ –ø—Ä–æ–≥–Ω–æ–∑–∏—Ä–æ–≤–∞–Ω–∏–µ", value=True, key="schedule_forecast")
    
    with col2:
        st.checkbox("–ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏–π –∏–º–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö", value=True, key="schedule_import")
        st.checkbox("Email –æ–ø–æ–≤–µ—â–µ–Ω–∏—è –æ–± –∞–Ω–æ–º–∞–ª–∏—è—Ö", value=False, key="schedule_email")
        st.checkbox("–ê–≤—Ç–æ–æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –æ –ø–æ–≥–æ–¥–µ", value=True, key="schedule_weather")

def render_model_settings():
    """–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –º–æ–¥–µ–ª–µ–π"""
    with st.expander("–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –∞–ª–≥–æ—Ä–∏—Ç–º–æ–≤", expanded=False):
        st.slider("–ú–∏–Ω–∏–º–∞–ª—å–Ω–æ–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ –∑–∞–ø–∏—Å–µ–π –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞", 1, 100, 10, key="model_min_records")
        st.slider("–ü–æ—Ä–æ–≥ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–∏—è –∞–Ω–æ–º–∞–ª–∏–π (%)", 1, 20, 5, key="model_anomaly_threshold")
        st.slider("–£—Ä–æ–≤–µ–Ω—å –¥–æ–≤–µ—Ä–∏—è –¥–ª—è –ø—Ä–æ–≥–Ω–æ–∑–æ–≤ (%)", 80, 99, 95, key="model_confidence_level")

def render_external_data_settings():
    """–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≤–Ω–µ—à–Ω–∏—Ö –¥–∞–Ω–Ω—ã—Ö"""
    with st.expander("–ù–∞—Å—Ç—Ä–æ–π–∫–∏ –≤–Ω–µ—à–Ω–∏—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤", expanded=False):
        st.checkbox("–ò–Ω—Ç–µ–≥—Ä–∞—Ü–∏—è —Å –ø–æ–≥–æ–¥–Ω—ã–º API", value=True, key="external_weather")
        st.checkbox("–£—á–µ—Ç –ø—Ä–∞–∑–¥–Ω–∏—á–Ω—ã—Ö –¥–Ω–µ–π", value=True, key="external_holidays")
        st.checkbox("–£—á–µ—Ç —Ç–µ–º–ø–µ—Ä–∞—Ç—É—Ä—ã", value=True, key="external_temperature")
        
        if st.button("üîÑ –ó–∞–≥—Ä—É–∑–∏—Ç—å –≤–Ω–µ—à–Ω–∏–µ –¥–∞–Ω–Ω—ã–µ", key="load_external_data"):
            st.info("üîó –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –æ –ø–æ–≥–æ–¥–µ –∏ –ø—Ä–∞–∑–¥–Ω–∏–∫–∞—Ö...")
            st.success("‚úÖ –í–Ω–µ—à–Ω–∏–µ –¥–∞–Ω–Ω—ã–µ —É—Å–ø–µ—à–Ω–æ –∑–∞–≥—Ä—É–∂–µ–Ω—ã")

def render_data_cleanup():
    """–û—á–∏—Å—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö"""
    if st.button("üóëÔ∏è –û—á–∏—Å—Ç–∏—Ç—å –≤—Å–µ –¥–∞–Ω–Ω—ã–µ –∏–∑ –ø–∞–º—è—Ç–∏", key="clear_data"):
        clear_session_data()
        st.rerun()
    
    st.warning("‚ö†Ô∏è –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ —É–¥–∞–ª–∏—Ç –≤—Å–µ –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ –∏ —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ã –∞–Ω–∞–ª–∏–∑–∞!")

def clear_session_data():
    """–û—á–∏—Å—Ç–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∏–∑ session_state"""
    for key in ['df', 'clusters', 'anomalies', 'forecast']:
        if key in st.session_state:
            del st.session_state[key]
    st.session_state.processed = False

def render_welcome_screen():
    """–≠–∫—Ä–∞–Ω –ø—Ä–∏–≤–µ—Ç—Å—Ç–≤–∏—è"""
    st.info("üëà –ó–∞–≥—Ä—É–∑–∏—Ç–µ CSV —Ñ–∞–π–ª —á–µ—Ä–µ–∑ –ø–∞–Ω–µ–ª—å —Å–ª–µ–≤–∞ –¥–ª—è –Ω–∞—á–∞–ª–∞ –∞–Ω–∞–ª–∏–∑–∞")
    
    col1, col2 = st.columns(2)
    
    with col1:
        st.markdown("""
        ### üìã –û–∂–∏–¥–∞–µ–º—ã–π —Ñ–æ—Ä–º–∞—Ç —Ñ–∞–π–ª–∞:
        - **–†–∞–∑–¥–µ–ª–∏—Ç–µ–ª—å**: —Ç–æ—á–∫–∞ —Å –∑–∞–ø—è—Ç–æ–π (`;`)
        - **–ö–æ–¥–∏—Ä–æ–≤–∫–∞**: UTF-8
        - **–ö–æ–ª–æ–Ω–∫–∏**: —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ, ID –∞–±–æ–Ω–µ–Ω—Ç–∞, ID –ø—Ä–∏–±–æ—Ä–∞, –¥–∞—Ç–∞, –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏–µ, –∏—Å—Ç–æ—á–Ω–∏–∫
        - **–ü—Ä–∏–º–µ—Ä —Å—Ç—Ä–æ–∫–∏**: 
        ```
        "–≥.–ê–º–≤—Ä–æ—Å–∏–µ–≤–∫–∞";"101000000001";1734754;01.01.2020;35915;"–ø–æ –∫–≤–∏—Ç–∞–Ω—Ü–∏–∏"
        ```
        """)
    
    with col2:
        st.markdown("""
        ### üéØ –î–æ—Å—Ç—É–ø–Ω—ã–µ —Ñ—É–Ω–∫—Ü–∏–∏:
        
        **üìä –ê–Ω–∞–ª–∏–∑ –¥–∞–Ω–Ω—ã—Ö (UC-VIEW-01):**
        - –ü—Ä–æ—Å–º–æ—Ç—Ä —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫–∏ –∏ –≥—Ä–∞—Ñ–∏–∫–æ–≤
        - –§–∏–ª—å—Ç—Ä–∞—Ü–∏—è –ø–æ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è–º –∏ –ø–µ—Ä–∏–æ–¥—É
        - –≠–∫—Å–ø–æ—Ä—Ç –¥–∞–Ω–Ω—ã—Ö –≤ CSV/Excel
        
        **üîç –ö–ª–∞—Å—Ç–µ—Ä–∏–∑–∞—Ü–∏—è (UC-ANL-01):**
        - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Å–µ–≥–º–µ–Ω—Ç–∞—Ü–∏—è –∞–±–æ–Ω–µ–Ω—Ç–æ–≤
        - 2 –∞–ª–≥–æ—Ä–∏—Ç–º–∞: K-means –∏ –∏–µ—Ä–∞—Ä—Ö–∏—á–µ—Å–∫–∞—è
        - –í–∏–∑—É–∞–ª–∏–∑–∞—Ü–∏—è –∫–ª–∞—Å—Ç–µ—Ä–æ–≤ –∏ –ø—Ä–æ—Ñ–∏–ª–µ–π
        
        **‚ö†Ô∏è –û–±–Ω–∞—Ä—É–∂–µ–Ω–∏–µ –∞–Ω–æ–º–∞–ª–∏–π (UC-ANL-02):**
        - –í—ã—è–≤–ª–µ–Ω–∏–µ —É—Ç–µ—á–µ–∫ –∏ —Ö–∏—â–µ–Ω–∏–π
        - –û—Ü–µ–Ω–∫–∞ —É—Ä–æ–≤–Ω—è –∞–Ω–æ–º–∞–ª—å–Ω–æ—Å—Ç–∏
        - Email –æ–ø–æ–≤–µ—â–µ–Ω–∏—è
        
        **üìà –ü—Ä–æ–≥–Ω–æ–∑–∏—Ä–æ–≤–∞–Ω–∏–µ (UC-ANL-03):**
        - –ü—Ä–æ–≥–Ω–æ–∑ –ø–æ—Ç—Ä–µ–±–ª–µ–Ω–∏—è –Ω–∞ 1-12 –º–µ—Å—è—Ü–µ–≤
        - –£—á–µ—Ç —Å–µ–∑–æ–Ω–Ω–æ—Å—Ç–∏ –∏ –ø–æ–≥–æ–¥—ã
        - –î–æ–≤–µ—Ä–∏—Ç–µ–ª—å–Ω—ã–µ –∏–Ω—Ç–µ—Ä–≤–∞–ª—ã
        
        **üìã –û—Ç—á–µ—Ç—ã (US-VIE-02):**
        - –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–µ –æ—Ç—á–µ—Ç–æ–≤
        - –≠–∫—Å–ø–æ—Ä—Ç –≤ PDF/CSV/Excel/HTML
        - –ö–æ–º–ø–ª–µ–∫—Å–Ω—ã–π –∞–Ω–∞–ª–∏–∑ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç–∏
        """)